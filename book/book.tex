%!TEX program = xelatex
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% book template
%% WisdomFusion@gmail.com
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[a4paper,twoside]{ctexbook}
\usepackage{fontspec}
\usepackage{xunicode}
\usepackage{geometry}
\usepackage{fancyhdr}
\usepackage{graphicx}
\usepackage{enumerate}
\usepackage{amsmath,mathrsfs,amsfonts}
\usepackage[dvipsnames]{xcolor}
\usepackage[clearempty]{titlesec}
\usepackage{minitoc}
\usepackage{caption}
\usepackage{tabularx}
\usepackage{booktabs}
\usepackage{colortbl}
\usepackage{multirow,makecell}
\usepackage{ulem} % \uline
\usepackage{multicol}
\usepackage{listings}
\usepackage{lipsum}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% hyperref settings
%% 超链接设定
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{hyperref}
\hypersetup{
  bookmarksnumbered,
  colorlinks,
  linkcolor={magenta},
  citecolor={magenta},
  urlcolor={teal}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% hyperref settings
%% 超链接设定
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\geometry{
  textwidth=138mm,
  textheight=215mm,
  %% left=27mm,
  %% or
  inner=23mm,
  %% right=27mm,
  %% or
  outer=18mm,
  top=25.4mm, bottom=25.4mm,
  headheight=2.17cm,
  headsep=4mm,
  footskip=12mm
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% fonts settings
%% 字体设定
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% \usepackage{ebgaramond}

\setmainfont[Ligatures=TeX]{Minion Pro}
\setsansfont{Myriad Pro}
\setmonofont{Inconsolata}

\setCJKmainfont[BoldFont={方正小标宋_GBK}, ItalicFont={方正楷体_GBK}, BoldItalicFont={方正仿宋_GBK}]{方正书宋_GBK}
\setCJKsansfont{方正黑体_GBK}
\setCJKmonofont{方正中等线_GBK}

\XeTeXlinebreaklocale "zh"
\XeTeXlinebreakskip = 0pt plus 1pt

\newfontfamily\fzss{方正书宋_GBK}
\newfontfamily\fzxbs{方正小标宋_GBK}
\newfontfamily\fzhei{方正黑体_GBK}
\newfontfamily\fzkai{方正楷体_GBK}
\newfontfamily\fzfs{方正仿宋_GBK}
\newfontfamily\fzzdx{方正中等线_GBK}

\newfontfamily\garamond{Adobe Garamond Pro}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% titlesec
%% 标题设定
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% chapter
\titleformat{\chapter} % command
  [display] % shape
  {\bfseries} % format
  {
    \rule{\textwidth}{0.5pt}
    \flushright
    \zihao{-4}
    第 \thechapter 章
  } % label
  {1ex} % sep
  {
    \vspace{5ex}
    \flushright
    \zihao{3}
  } % before-code
  [
  \vspace{-0.5ex}%
  \rule{\textwidth}{1pt}
  ] % after-code


%% section
\titleformat{\section}
  [hang]
  {\rmfamily}
  {\centering\zihao{-3}\bfseries\thesection\enspace}
  {1pt}
  {\zihao{-3}\bfseries}

%% subsection
\titleformat{\subsection}
  [hang]
  {\rmfamily}
  {\zihao{-4}\bfseries\thesubsection\enspace}
  {1pt}
  {\zihao{4}\bfseries\filright}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Chinese names
%% 中文名称
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\renewcommand{\contentsname}{目\hspace{1em}录}
\renewcommand{\figurename}{图}
\renewcommand{\tablename}{表}
\renewcommand{\partname}{部分}
\renewcommand{\listfigurename}{插图目录}
\renewcommand{\listtablename}{表格目录}
\renewcommand{\bibname}{参考文献}
\renewcommand{\appendixname}{附\hspace{1em}录}
\renewcommand{\indexname}{索\hspace{1em}引}

\renewcommand{\lstlistingname}{代码}
\renewcommand{\lstlistlistingname}{\lstlistingname 列表}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% code listings
%% 代码块设定
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\colorlet{lightergray}{black!5!white}

\lstdefinestyle{mystyle}{
  %backgroundcolor=\color{lightergray},
  commentstyle=\color{gray},
  keywordstyle=\color{blue},
  numberstyle=\color{gray},
  stringstyle=\color{red},
  basicstyle=\ttfamily,
  morekeywords={as},
  breakatwhitespace=false,
  breaklines=true,
  captionpos=t,
  keepspaces=true,
  numbers=none,
  numbersep=5pt,
  showspaces=false,
  showstringspaces=false,
  showtabs=false,
  %xleftmargin=.75cm,
  frame=tlbr,
  framesep=5pt,
  framerule=0pt,
  %rulecolor=\color{lightgray}
}
\lstset{style=mystyle}

%% 代码列表标题
\DeclareCaptionFormat{codecaptionformat}{%
  \colorbox{black!20}{
    \parbox{\textwidth}{#1#2\ttfamily#3}
  }
}
\captionsetup[lstlisting]{format=codecaptionformat}



%% 添加首行缩进，两个字符
\usepackage{indentfirst}
\setlength{\parindent}{2em}

%% 行距
\linespread{1.5}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% beginning of the book
%% 文档开始
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}

%% title page
\begin{titlepage}
  \vspace*{25ex}
  
  \hspace{0.05\textwidth}\begin{minipage}{.9\textwidth}
    \flushright
    
    %%中文书名
    {\zihao{1}\textbf{中文书名}}
    
    \rule[1ex]{\linewidth}{.5pt}
    
    %% 英文书名
    {\zihao{2}Book Title} \\
    
    \vspace{20ex}
    
    %% 作者
    {\zihao{4}\textit{胡志飞}~编著} \\
    
    \ctexset{
      today=big
    }
    {\zihao{4}\today}
  \end{minipage}
  
  \vfill
  
  \centering
  {\zihao{4}北京 ~$\bullet$ ~BEIJING}
\end{titlepage}
\thispagestyle{empty}


\frontmatter


\dominitoc
\mtcsettitle{minitoc}{本章内容}
\mtcsetrules{*}{off}


\chapter*{序}
%%\addstarredchapter{序}

本书作序。


\chapter*{前言}
%%\addstarredchapter{前言}

本书前言。


%% 目录
%%\addstarredchapter{目录}
{
  \hypersetup{hidelinks}
  \tableofcontents
}


%% 代码列表
%%\addstarredchapter{代码列表}
%%{
%%  \hypersetup{hidelinks}
%%  \lstlistoflistings
%%}


\mainmatter


\part{中文的部分标题}

\chapter{中文的章标题}

{
  \hypersetup{hidelinks}
  \minitoc
}

\vspace{10ex}

\lipsum[3]

\section{中文的节标题}

\lipsum[3-5]

\begin{equation}
  \label{eq:1}
   \lim_{x\to 0}{\frac{e^x-1}{2x}}
   \overset{\left[\frac{0}{0}\right]}{\underset{\mathrm{H}}{=}}
   \lim_{x\to 0}{\frac{e^x}{2}}={\frac{1}{2}}
\end{equation}

\subsection{subsection 小节}

中文\textbf{字体}测试。测试\textbf{中文和\textit{English字体样式}}。公式\ref{eq:1}

{\fzfs 仿宋}

\subsection{subsection 小节2}

代码示例：

\begin{lstlisting}[language=Python,caption={Python example}]
import numpy as np

def incmatrix(genl1,genl2):
    m = len(genl1)
    n = len(genl2)
    M = None #to become the incidence matrix
    VT = np.zeros((n*m,1), int)  #dummy variable

    #compute the bitwise xor matrix
    M1 = bitxormatrix(genl1)
    M2 = np.triu(bitxormatrix(genl2),1)

    for i in range(m-1):
        for j in range(i+1, m):
            [r,c] = np.where(M2 == M1[i,j])
            for k in range(len(r)):
                VT[(i)*n + r[k]] = 1;
                VT[(i)*n + c[k]] = 1;
                VT[(j)*n + r[k]] = 1;
                VT[(j)*n + c[k]] = 1;

                if M is None:
                    M = np.copy(VT)
                else:
                    M = np.concatenate((M, VT), 1)

                VT = np.zeros((n*m,1), int)

    return M
\end{lstlisting}


\section{English section title}

\lipsum[2-5]

\chapter{English chapter title}

{
  \hypersetup{hidelinks}
  \minitoc
}

\vspace{10ex}

\lipsum[3]


\section{再来一个小节}

该小节的内容。


\end{document}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
